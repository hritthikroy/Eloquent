<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self'; style-src 'self' 'unsafe-inline'; img-src 'self' data:; font-src 'self'; connect-src 'self' http://localhost:3000;">
  <title>User Management - Eloquent Admin</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
      background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
      min-height: 100vh;
      color: white;
      padding: 20px;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
    }

    .header {
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(20px);
      border-radius: 16px;
      padding: 24px;
      margin-bottom: 24px;
      border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .header h1 {
      font-size: 28px;
      margin-bottom: 8px;
    }

    .header p {
      color: rgba(255, 255, 255, 0.7);
      font-size: 14px;
    }

    .card {
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(20px);
      border-radius: 16px;
      padding: 24px;
      margin-bottom: 20px;
      border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .card h2 {
      font-size: 20px;
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .controls {
      display: grid;
      grid-template-columns: 1fr auto auto;
      gap: 12px;
      margin-bottom: 20px;
    }

    input, select {
      padding: 12px 16px;
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 10px;
      background: rgba(255, 255, 255, 0.1);
      color: white;
      font-size: 14px;
      font-family: inherit;
    }

    input::placeholder {
      color: rgba(255, 255, 255, 0.5);
    }

    input:focus, select:focus {
      outline: none;
      border-color: #3b82f6;
      background: rgba(255, 255, 255, 0.15);
    }

    .btn {
      padding: 12px 24px;
      border: none;
      border-radius: 10px;
      font-weight: 600;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.3s;
    }

    .btn-primary {
      background: #3b82f6;
      color: white;
    }

    .btn-primary:hover {
      background: #2563eb;
      transform: translateY(-2px);
    }

    .btn-success {
      background: #10b981;
      color: white;
    }

    .btn-success:hover {
      background: #059669;
    }

    .btn-danger {
      background: #ef4444;
      color: white;
    }

    .btn-danger:hover {
      background: #dc2626;
    }

    .btn-small {
      padding: 6px 12px;
      font-size: 12px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
    }

    th, td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    th {
      background: rgba(255, 255, 255, 0.1);
      font-weight: 600;
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .badge {
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
    }

    .plan-free { background: #6b7280; }
    .plan-starter { background: #3b82f6; }
    .plan-pro { background: #8b5cf6; }
    .plan-unlimited { background: #f59e0b; }
    .plan-enterprise { background: #10b981; }

    .role-user { background: #6b7280; }
    .role-admin { background: #ef4444; }
    .role-moderator { background: #f59e0b; }

    .status-active { background: #10b981; }
    .status-none { background: #6b7280; }
    .status-cancelled { background: #ef4444; }

    .user-avatar {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: linear-gradient(135deg, #3b82f6, #8b5cf6);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      font-size: 14px;
      margin-right: 12px;
    }

    .user-info {
      display: flex;
      align-items: center;
    }

    .user-details {
      display: flex;
      flex-direction: column;
    }

    .user-name {
      font-weight: 600;
      font-size: 14px;
    }

    .user-email {
      color: rgba(255, 255, 255, 0.7);
      font-size: 12px;
    }

    .alert {
      padding: 12px 16px;
      border-radius: 10px;
      margin-bottom: 20px;
      font-size: 14px;
    }

    .alert-success {
      background: rgba(16, 185, 129, 0.2);
      border: 1px solid rgba(16, 185, 129, 0.4);
      color: #10b981;
    }

    .alert-error {
      background: rgba(239, 68, 68, 0.2);
      border: 1px solid rgba(239, 68, 68, 0.4);
      color: #ef4444;
    }

    .hidden {
      display: none;
    }

    .loading {
      text-align: center;
      padding: 40px;
      color: rgba(255, 255, 255, 0.7);
    }

    .spinner {
      width: 40px;
      height: 40px;
      border: 3px solid rgba(255, 255, 255, 0.2);
      border-top-color: white;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      margin: 0 auto 16px;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .usage-bar {
      width: 100%;
      height: 6px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 3px;
      overflow: hidden;
      margin-top: 4px;
    }

    .usage-fill {
      height: 100%;
      background: linear-gradient(90deg, #10b981, #3b82f6);
      border-radius: 3px;
      transition: width 0.3s;
    }

    .usage-fill.warning { background: linear-gradient(90deg, #f59e0b, #ef4444); }
    .usage-fill.danger { background: linear-gradient(90deg, #ef4444, #dc2626); }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>üë• User Management</h1>
      <p>View and manage user accounts and subscriptions</p>
    </div>

    <div id="alertContainer"></div>

    <div class="card">
      <h2>üîç Search & Filter</h2>
      
      <div class="controls">
        <input type="text" id="searchInput" placeholder="Search by email or name...">
        <select id="planFilter">
          <option value="">All Plans</option>
          <option value="free">Free</option>
          <option value="starter">Starter</option>
          <option value="pro">Pro</option>
          <option value="unlimited">Unlimited</option>
          <option value="enterprise">Enterprise</option>
        </select>
        <button class="btn btn-primary" onclick="loadUsers()">Refresh</button>
        <button class="btn btn-success" onclick="forceDevMode()">Force Dev Mode</button>
      </div>

      <div id="loadingContainer" class="loading">
        <div class="spinner"></div>
        <p>Loading users...</p>
      </div>

      <div id="usersContainer" class="hidden">
        <table>
          <thead>
            <tr>
              <th>User</th>
              <th>Plan</th>
              <th>Role</th>
              <th>Usage</th>
              <th>Status</th>
              <th>Last Login</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="usersTable">
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <script>
    // Check if running in Electron
    const isElectron = typeof require !== 'undefined';
    let API_BASE = 'http://localhost:3000/api';
    let authToken = '';

    console.log('User Management window loaded');
    console.log('Is Electron:', isElectron);

    if (isElectron) {
      const { ipcRenderer } = require('electron');
      
      console.log('Requesting auth token from main process...');
      
      // Get auth token from Electron
      ipcRenderer.invoke('get-auth-token').then(token => {
        console.log('Auth token response:', token ? 'Token received' : 'No token');
        if (!token) {
          console.log('No token received, trying development mode fallback...');
          authToken = 'dev-token';
          showAlert('Using development mode authentication', 'success');
          loadUsers();
          return;
        }
        authToken = token;
        console.log('Auth token received, loading users...');
        loadUsers();
      }).catch(error => {
        console.error('Failed to get auth token:', error);
        
        // Development mode fallback - try using dev-token directly
        if (error.message.includes('Not authenticated') || error.message.includes('Admin access required')) {
          console.log('Trying development mode fallback with dev-token...');
          authToken = 'dev-token';
          showAlert('Using development mode authentication', 'success');
          loadUsers();
        } else {
          showAlert('Authentication error: ' + error.message + '. Try restarting the app or signing in again.', 'error');
          
          // Show additional debugging info
          console.log('Debug info:');
          console.log('- Make sure you are signed in');
          console.log('- Make sure you have admin privileges');
          console.log('- Try restarting the application');
        }
      });
    } else {
      // Running in browser, use localStorage
      authToken = localStorage.getItem('access_token');
      if (!authToken) {
        showAlert('Not authenticated. Please log in.', 'error');
      } else {
        loadUsers();
      }
    }

    let allUsers = [];

    async function loadUsers() {
      const loadingContainer = document.getElementById('loadingContainer');
      const usersContainer = document.getElementById('usersContainer');
      
      loadingContainer.classList.remove('hidden');
      usersContainer.classList.add('hidden');

      try {
        console.log('Making request to:', `${API_BASE}/admin/users`);
        console.log('Auth token available:', !!authToken);
        console.log('Auth token value:', authToken);
        
        if (!authToken) {
          throw new Error('No authentication token available');
        }
        
        const response = await fetch(`${API_BASE}/admin/users`, {
          headers: {
            'Authorization': `Bearer ${authToken}`,
            'Content-Type': 'application/json'
          }
        });

        console.log('Response status:', response.status);
        console.log('Response headers:', Object.fromEntries(response.headers.entries()));

        if (!response.ok) {
          const errorText = await response.text();
          console.error('Error response:', errorText);
          
          if (response.status === 401) {
            throw new Error('Unauthorized - Please sign in again or check admin permissions');
          } else if (response.status === 403) {
            throw new Error('Forbidden - Admin access required');
          } else {
            throw new Error(`Server error (${response.status}): ${errorText}`);
          }
        }

        const data = await response.json();
        console.log('Users data received:', data);
        allUsers = data.users || [];
        
        renderUsers(allUsers);
        
        loadingContainer.classList.add('hidden');
        usersContainer.classList.remove('hidden');
      } catch (error) {
        console.error('Error loading users:', error);
        showAlert('Failed to load users: ' + error.message, 'error');
        loadingContainer.classList.add('hidden');
      }
    }

    function renderUsers(users) {
      const tbody = document.getElementById('usersTable');
      
      if (users.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 40px; color: rgba(255, 255, 255, 0.5);">No users found</td></tr>';
        return;
      }

      tbody.innerHTML = users.map(user => {
        const usageLimit = getUsageLimit(user.plan);
        const usagePercent = usageLimit === '‚àû' ? 0 : Math.min(100, (user.usage_current_month / usageLimit) * 100);
        const usageClass = usagePercent > 90 ? 'danger' : usagePercent > 75 ? 'warning' : '';

        return `
          <tr>
            <td>
              <div class="user-info">
                <div class="user-avatar">${getInitials(user.email)}</div>
                <div class="user-details">
                  <div class="user-name">${user.name || 'Unknown'}</div>
                  <div class="user-email">${user.email}</div>
                </div>
              </div>
            </td>
            <td><span class="badge plan-${user.plan}">${user.plan}</span></td>
            <td><span class="badge role-${user.role}">${user.role}</span></td>
            <td>
              <div>
                <span style="font-size: 13px;">${user.usage_current_month || 0} / ${usageLimit} min</span>
                <div class="usage-bar">
                  <div class="usage-fill ${usageClass}" style="width: ${usagePercent}%"></div>
                </div>
              </div>
            </td>
            <td><span class="badge status-${user.subscription_status}">${user.subscription_status}</span></td>
            <td style="color: rgba(255, 255, 255, 0.7); font-size: 13px;">
              ${user.last_login ? formatDate(user.last_login) : 'Never'}
            </td>
            <td>
              <div style="display: flex; gap: 8px;">
                <button class="btn btn-success btn-small" onclick="editUser('${user.id}')">Edit Plan</button>
                <button class="btn btn-danger btn-small" onclick="deleteUser('${user.id}')">Delete</button>
              </div>
            </td>
          </tr>
        `;
      }).join('');
    }

    // Search and filter
    document.getElementById('searchInput').addEventListener('input', (e) => {
      const query = e.target.value.toLowerCase();
      const filtered = allUsers.filter(user => 
        user.email.toLowerCase().includes(query) || 
        (user.name && user.name.toLowerCase().includes(query))
      );
      renderUsers(filtered);
    });

    document.getElementById('planFilter').addEventListener('change', (e) => {
      const plan = e.target.value;
      const filtered = plan ? allUsers.filter(user => user.plan === plan) : allUsers;
      renderUsers(filtered);
    });

    async function editUser(userId) {
      const user = allUsers.find(u => u.id === userId);
      if (!user) return;

      const newPlan = prompt(
        `Change plan for ${user.email}\n\nCurrent plan: ${user.plan}\n\nEnter new plan:`,
        user.plan
      );

      if (!newPlan || newPlan === user.plan) return;

      const validPlans = ['free', 'starter', 'pro', 'unlimited', 'enterprise'];
      if (!validPlans.includes(newPlan)) {
        showAlert('Invalid plan. Valid options: ' + validPlans.join(', '), 'error');
        return;
      }

      try {
        const response = await fetch(`${API_BASE}/admin/users/${userId}/plan`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${authToken}`
          },
          body: JSON.stringify({
            plan: newPlan,
            subscription_status: newPlan === 'free' ? 'none' : 'active',
            subscription_end_date: newPlan === 'free' ? null : new Date(Date.now() + 30 * 24 * 60 * 60 * 1000)
          })
        });

        if (!response.ok) throw new Error('Failed to update plan');

        showAlert(`Plan updated to ${newPlan} successfully!`, 'success');
        loadUsers();
      } catch (error) {
        showAlert('Failed to update plan: ' + error.message, 'error');
      }
    }

    async function deleteUser(userId) {
      const user = allUsers.find(u => u.id === userId);
      if (!user) return;

      if (!confirm(`Delete user ${user.email}?\n\nThis action cannot be undone.`)) return;

      try {
        const response = await fetch(`${API_BASE}/admin/users/${userId}`, {
          method: 'DELETE',
          headers: {
            'Authorization': `Bearer ${authToken}`
          }
        });

        if (!response.ok) throw new Error('Failed to delete user');

        showAlert('User deleted successfully!', 'success');
        loadUsers();
      } catch (error) {
        showAlert('Failed to delete user: ' + error.message, 'error');
      }
    }

    function showAlert(message, type) {
      const container = document.getElementById('alertContainer');
      const alert = document.createElement('div');
      alert.className = `alert alert-${type}`;
      alert.textContent = message;
      
      container.innerHTML = '';
      container.appendChild(alert);
      
      setTimeout(() => alert.remove(), 5000);
    }

    function getInitials(email) {
      return email.substring(0, 2).toUpperCase();
    }

    function getUsageLimit(plan) {
      const limits = {
        'free': 60,
        'starter': 180,
        'pro': 600,
        'unlimited': '‚àû',
        'enterprise': '‚àû'
      };
      return limits[plan] || 60;
    }

    function formatDate(dateString) {
      const date = new Date(dateString);
      const now = new Date();
      const diffMs = now - date;
      const diffMins = Math.floor(diffMs / 60000);
      const diffHours = Math.floor(diffMs / 3600000);
      const diffDays = Math.floor(diffMs / 86400000);

      if (diffMins < 60) return `${diffMins}m ago`;
      if (diffHours < 24) return `${diffHours}h ago`;
      if (diffDays < 7) return `${diffDays}d ago`;
      return date.toLocaleDateString();
    }

    function forceDevMode() {
      console.log('Forcing development mode...');
      authToken = 'dev-token';
      showAlert('Forced development mode - using dev-token', 'success');
      loadUsers();
    }
  </script>
</body>
</html>
