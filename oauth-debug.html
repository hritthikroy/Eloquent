<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>OAuth Debug - Eloquent</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            margin: 0;
            padding: 30px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            min-height: 100vh;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.1);
            padding: 30px;
            border-radius: 15px;
            backdrop-filter: blur(10px);
        }
        h1 { text-align: center; margin-bottom: 30px; }
        .section {
            background: rgba(255, 255, 255, 0.1);
            padding: 20px;
            margin: 15px 0;
            border-radius: 10px;
            border-left: 4px solid #4CAF50;
        }
        .error { border-left-color: #f44336; }
        .warning { border-left-color: #ff9800; }
        button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            margin: 10px 5px;
        }
        button:hover { background: #45a049; }
        .code {
            background: rgba(0, 0, 0, 0.3);
            padding: 15px;
            border-radius: 8px;
            font-family: monospace;
            margin: 10px 0;
            word-break: break-all;
        }
        .status {
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            font-weight: bold;
        }
        .success { background: rgba(76, 175, 80, 0.2); color: #4CAF50; }
        .fail { background: rgba(244, 67, 54, 0.2); color: #f44336; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç OAuth Debug Tool</h1>
        
        <div class="section">
            <h3>Current URL Analysis</h3>
            <div class="code" id="current-url"></div>
            <div id="url-analysis"></div>
        </div>

        <div class="section">
            <h3>Token Extraction</h3>
            <div id="token-info"></div>
        </div>

        <div class="section">
            <h3>Configuration Test</h3>
            <button onclick="testSupabaseConfig()">Test Supabase Connection</button>
            <button onclick="testBackendConfig()">Test Backend Connection</button>
            <div id="config-results"></div>
        </div>

        <div class="section">
            <h3>Manual OAuth Fix</h3>
            <p>If automatic OAuth isn't working, try these steps:</p>
            <ol>
                <li>Copy the current URL from above</li>
                <li>Click the button below to trigger manual OAuth</li>
                <li>Or use the protocol link: <a href="eloquent://auth/manual" style="color: #4CAF50;">eloquent://auth/manual</a></li>
            </ol>
            <button onclick="triggerManualOAuth()">üîß Trigger Manual OAuth</button>
        </div>

        <div class="section">
            <h3>Debug Actions</h3>
            <button onclick="copyDebugInfo()">üìã Copy Debug Info</button>
            <button onclick="testProtocolHandler()">üîó Test Protocol Handler</button>
            <button onclick="clearCache()">üóëÔ∏è Clear OAuth Cache</button>
        </div>
    </div>

    <script>
        // Display current URL
        document.getElementById('current-url').textContent = window.location.href;

        // Analyze URL for OAuth tokens
        function analyzeURL() {
            const url = window.location.href;
            const hash = window.location.hash.substring(1);
            const search = window.location.search.substring(1);
            
            let tokens = {};
            let source = 'none';
            
            // Check hash fragment (Supabase default)
            if (hash) {
                const hashParams = new URLSearchParams(hash);
                if (hashParams.get('access_token')) {
                    tokens = {
                        access_token: hashParams.get('access_token'),
                        refresh_token: hashParams.get('refresh_token'),
                        expires_in: hashParams.get('expires_in'),
                        token_type: hashParams.get('token_type')
                    };
                    source = 'hash';
                }
            }
            
            // Check query parameters
            if (!tokens.access_token && search) {
                const searchParams = new URLSearchParams(search);
                if (searchParams.get('access_token')) {
                    tokens = {
                        access_token: searchParams.get('access_token'),
                        refresh_token: searchParams.get('refresh_token'),
                        expires_in: searchParams.get('expires_in'),
                        token_type: searchParams.get('token_type')
                    };
                    source = 'query';
                }
            }
            
            // Display results
            const analysisDiv = document.getElementById('url-analysis');
            const tokenDiv = document.getElementById('token-info');
            
            if (tokens.access_token) {
                analysisDiv.innerHTML = `<div class="status success">‚úÖ OAuth tokens found in ${source} parameters</div>`;
                tokenDiv.innerHTML = `
                    <div class="status success">‚úÖ Valid OAuth Response</div>
                    <div class="code">
                        Access Token: ${tokens.access_token.substring(0, 20)}...<br>
                        Refresh Token: ${tokens.refresh_token ? tokens.refresh_token.substring(0, 20) + '...' : 'Not provided'}<br>
                        Expires In: ${tokens.expires_in || 'Not specified'}<br>
                        Token Type: ${tokens.token_type || 'bearer'}
                    </div>
                    <button onclick="sendToElectron(${JSON.stringify(tokens).replace(/"/g, '&quot;')})">üöÄ Send to Eloquent</button>
                `;
            } else {
                // Check for errors
                const urlParams = new URLSearchParams(search);
                const hashParams = new URLSearchParams(hash);
                const error = urlParams.get('error') || hashParams.get('error');
                const errorDescription = urlParams.get('error_description') || hashParams.get('error_description');
                
                if (error) {
                    analysisDiv.innerHTML = `<div class="status fail">‚ùå OAuth Error: ${error}</div>`;
                    tokenDiv.innerHTML = `
                        <div class="status fail">‚ùå OAuth Failed</div>
                        <div class="code">
                            Error: ${error}<br>
                            Description: ${errorDescription || 'No description provided'}
                        </div>
                    `;
                } else {
                    analysisDiv.innerHTML = `<div class="status fail">‚ùå No OAuth tokens found</div>`;
                    tokenDiv.innerHTML = `<div class="status fail">‚ùå This doesn't appear to be an OAuth callback URL</div>`;
                }
            }
        }

        function sendToElectron(tokens) {
            // Try multiple methods to communicate with Electron
            const protocolUrl = `eloquent://auth/success?access_token=${tokens.access_token}&refresh_token=${tokens.refresh_token || ''}`;
            
            try {
                // Method 1: Protocol handler
                window.location.href = protocolUrl;
            } catch (e) {
                console.log('Protocol redirect failed:', e);
                
                // Method 2: Copy to clipboard
                navigator.clipboard.writeText(protocolUrl).then(() => {
                    alert('Protocol URL copied to clipboard! Paste it in Eloquent manual OAuth fix window.');
                }).catch(() => {
                    // Method 3: Show URL for manual copy
                    prompt('Copy this URL and paste it in Eloquent:', protocolUrl);
                });
            }
        }

        async function testSupabaseConfig() {
            const resultsDiv = document.getElementById('config-results');
            resultsDiv.innerHTML = '<div class="status">üîÑ Testing Supabase connection...</div>';
            
            try {
                const response = await fetch('https://apphxfvhpqogsquqlaol.supabase.co/auth/v1/settings', {
                    headers: {
                        'apikey': 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFwcGh4ZnZocHFvZ3NxdXFsYW9sIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYwMTMyMTUsImV4cCI6MjA4MTU4OTIxNX0.Z63Kpf2la_bQUmlySXzDLXmh6wowkuYiIFIuROcmgKk'
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    resultsDiv.innerHTML = `
                        <div class="status success">‚úÖ Supabase connection successful</div>
                        <div class="code">Google OAuth: ${data.external.google ? 'Enabled' : 'Disabled'}</div>
                    `;
                } else {
                    resultsDiv.innerHTML = `<div class="status fail">‚ùå Supabase connection failed: ${response.status}</div>`;
                }
            } catch (error) {
                resultsDiv.innerHTML = `<div class="status fail">‚ùå Supabase connection error: ${error.message}</div>`;
            }
        }

        async function testBackendConfig() {
            const resultsDiv = document.getElementById('config-results');
            resultsDiv.innerHTML += '<div class="status">üîÑ Testing backend connection...</div>';
            
            try {
                const response = await fetch('https://agile-basin-06335-9109082620ce.herokuapp.com/health');
                
                if (response.ok) {
                    resultsDiv.innerHTML += '<div class="status success">‚úÖ Backend connection successful</div>';
                } else {
                    resultsDiv.innerHTML += `<div class="status fail">‚ùå Backend connection failed: ${response.status}</div>`;
                }
            } catch (error) {
                resultsDiv.innerHTML += `<div class="status fail">‚ùå Backend connection error: ${error.message}</div>`;
            }
        }

        function triggerManualOAuth() {
            window.location.href = 'eloquent://auth/manual';
        }

        function testProtocolHandler() {
            window.location.href = 'eloquent://test';
        }

        function clearCache() {
            localStorage.clear();
            sessionStorage.clear();
            alert('OAuth cache cleared!');
        }

        function copyDebugInfo() {
            const debugInfo = `
OAuth Debug Information:
- URL: ${window.location.href}
- Hash: ${window.location.hash}
- Search: ${window.location.search}
- User Agent: ${navigator.userAgent}
- Timestamp: ${new Date().toISOString()}
            `.trim();
            
            navigator.clipboard.writeText(debugInfo).then(() => {
                alert('Debug info copied to clipboard!');
            }).catch(() => {
                prompt('Copy this debug info:', debugInfo);
            });
        }

        // Run analysis on page load
        analyzeURL();
    </script>
</body>
</html>