<!DOCTYPE html>
<html>
<head>
    <title>Test OAuth Redirect</title>
</head>
<body>
    <h1>OAuth Redirect Test</h1>
    <p>This page simulates what happens after OAuth success.</p>
    
    <h2>Test Different Token Formats:</h2>
    
    <h3>1. Hash Fragment Format (Supabase default):</h3>
    <button onclick="testHashFormat()">Test Hash Format</button>
    <p>Simulates: <code>page.html#access_token=abc123&refresh_token=def456</code></p>
    
    <h3>2. Query Parameter Format:</h3>
    <button onclick="testQueryFormat()">Test Query Format</button>
    <p>Simulates: <code>page.html?access_token=abc123&refresh_token=def456</code></p>
    
    <h3>3. Current URL Debug:</h3>
    <button onclick="debugCurrentUrl()">Debug Current URL</button>
    <div id="debug-output"></div>
    
    <script>
        function testHashFormat() {
            // Simulate hash fragment tokens
            window.location.hash = '#access_token=test_hash_token_123&refresh_token=test_hash_refresh_456&expires_in=3600&token_type=bearer';
            
            // Extract tokens like the backend does
            const hash = window.location.hash.substring(1);
            const params = new URLSearchParams(hash);
            
            const tokens = {
                access_token: params.get('access_token'),
                refresh_token: params.get('refresh_token'),
                expires_in: params.get('expires_in'),
                token_type: params.get('token_type')
            };
            
            console.log('Hash format tokens:', tokens);
            
            if (tokens.access_token) {
                const protocolUrl = `eloquent://auth/success?access_token=${tokens.access_token}&refresh_token=${tokens.refresh_token || ''}`;
                console.log('Sending to Electron:', protocolUrl);
                window.location.href = protocolUrl;
            } else {
                alert('No tokens found in hash format');
            }
        }
        
        function testQueryFormat() {
            // Test with query parameters
            const tokens = {
                access_token: 'test_query_token_123',
                refresh_token: 'test_query_refresh_456'
            };
            
            const protocolUrl = `eloquent://auth/success?access_token=${tokens.access_token}&refresh_token=${tokens.refresh_token}`;
            console.log('Sending to Electron:', protocolUrl);
            window.location.href = protocolUrl;
        }
        
        function debugCurrentUrl() {
            const output = document.getElementById('debug-output');
            const currentUrl = window.location.href;
            const hash = window.location.hash;
            const search = window.location.search;
            
            output.innerHTML = `
                <h4>Current URL Debug:</h4>
                <p><strong>Full URL:</strong> ${currentUrl}</p>
                <p><strong>Hash:</strong> ${hash}</p>
                <p><strong>Search:</strong> ${search}</p>
                
                <h4>Hash Tokens:</h4>
                <pre>${JSON.stringify(getHashTokens(), null, 2)}</pre>
                
                <h4>Query Tokens:</h4>
                <pre>${JSON.stringify(getQueryTokens(), null, 2)}</pre>
            `;
        }
        
        function getHashTokens() {
            const hash = window.location.hash.substring(1);
            const params = new URLSearchParams(hash);
            return {
                access_token: params.get('access_token'),
                refresh_token: params.get('refresh_token'),
                expires_in: params.get('expires_in'),
                token_type: params.get('token_type')
            };
        }
        
        function getQueryTokens() {
            const search = window.location.search;
            const params = new URLSearchParams(search);
            return {
                access_token: params.get('access_token'),
                refresh_token: params.get('refresh_token'),
                expires_in: params.get('expires_in'),
                token_type: params.get('token_type')
            };
        }
    </script>
</body>
</html>